name: Build

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --group dev --all-extras

      - name: Run poe check
        run: uv run poe check

  build-tag-and-release:
    name: Build, Tag & Release
    needs: check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        python-version: 3.12
    
    - name: Build package
      run: |
        uv build
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-python
        path: dist/*
    
    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

    - name: Generate SHA-256 checksums
      shell: bash
      run: |
        shopt -s nullglob
        sha256sum dist/* >> CHECKSUMS
    
    - name: Tag & Push
      run: |
        VERSION=$(uv version --frozen --short)
        git add CHECKSUMS
        git commit -m "chore: Add release checksums for v$VERSION"
        git tag "v$VERSION"
        git push origin main "v$VERSION"

    - name: Release to PyPi
      run: "echo 'TODO: RELEASE TO PYPI'"
    
    - name: Bump version
      run: |
        NEW_VERSION=$(uv version --frozen --short --bump patch)
        echo "__version__ = \"$NEW_VERSION\"" > src/mcp_interviewer/_version.py
        git add pyproject.toml src/mcp_interviewer/_version.py
        git commit -m "chore: bump version to $NEW_VERSION"
        git push origin main
