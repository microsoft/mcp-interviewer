name: Release

permissions:
  contents: write
  id-token: write

on:
  workflow_dispatch:

jobs:
  build-tag-and-release:
    name: Build, Tag & Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        python-version: 3.12
    
    - name: Build package
      run: |
        uv build
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-python
        path: dist/*
    
    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

    - name: Generate SHA-256 checksums
      shell: bash
      run: |
        shopt -s nullglob
        sha256sum dist/* >> CHECKSUMS
    
    - name: Tag & Push
      run: |
        VERSION=$(uv version --frozen --short)
        git add CHECKSUMS
        git commit -m "chore: Add release checksums for v$VERSION"
        git tag "v$VERSION"
        git push origin main "v$VERSION"

    - name: Release to PyPi
      uses: pypa/gh-action-pypi-publish@release/v1
    
    - name: Bump version
      run: |
        NEW_VERSION=$(uv version --no-sync --short --bump patch)
        echo "__version__ = \"$NEW_VERSION\"" > src/mcp_interviewer/_version.py
        git add pyproject.toml uv.lock src/mcp_interviewer/_version.py
        git commit -m "chore: bump version to $NEW_VERSION"
        git push origin main
